# 権限

アクセス権限を管理するテーブル。

## テーブル情報

| 項目 | 値 |
|---|---|
| 論理テーブル名 | 権限 |
| 物理テーブル名 | permissions |

## カラム情報

| カラム名 | データ型 | 制約 | インデックス | 外部キー | 説明 |
|------|------|------|------|------|------|
| id | INT | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY | - | - | 権限の一意ID |
| permission_name | TEXT | NOT NULL, UNIQUE | - | - | 権限の名前 |
| status | TEXT | NOT NULL, DEFAULT '1' | - | - | 0: 無効<br>1: 有効 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | - | - | レコードの作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | - | - | レコードの更新日時<br>TRIGGERによる自動更新 |
| descriptions | TEXT | - | - | - | 補足 |

## トリガー

| No. | 論理名 | 物理名 | 概要 | 補足 |
|----|---|---|---|---|
| 1 | 日時自動更新 | - | updated_atを自動で更新する | - |

## 権限設定

RLS有効

| No. | ポリシー名 | permission_name | select | insert | update | delete |
|---|---|---|---|---|---|---|
| 1 | "Privilege Users have full access." | Privilege | * | * | * | * |
| 2 | "All Users can select their own rows." | * | 所属する権限のみ | - | - | - |

※Privilegeユーザのみフルアクセス可

## SQL定義

```sql
-- 02.権限
-- -- テーブル
CREATE TABLE permissions (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  permission_name TEXT NOT NULL UNIQUE,
  status TEXT NOT NULL DEFAULT '1',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  descriptions TEXT
);

-- -- トリガー
create trigger handle_permissions_updated_at before update on permissions
  for each row execute procedure moddatetime (updated_at);

-- -- アクセス権限
revoke all on permissions from anon;

-- -- RLS * 03.ユーザ権限テーブル作成後に実施
alter table permissions enable row level security;
create policy "All Users can select their own rows."
  on public.permissions
  for select
  to authenticated
  using (
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = permissions.id
    )
  );

create policy "Privilege Users have full access."
  on public.permissions
  to authenticated
  using (
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = 1
    )
  );

```

## 初期データ

Supabaseコンソール上で追加

| id | permission_name | status | created_at | updated_at | descriptions |
|---|---|---|---|---|---|
| 1 | Privilege | '1' | 自動生成 | 自動生成 | 主に開発時に利用, C: フルアクセス, R: フルアクセス, U: フルアクセス, D: フルアクセス, 管理ページログイン可 |
| 2 | Admin | '1' | 自動生成 | 自動生成 | 本番運用にて利用, C: 自テナントの情報のみ, R: 自分の情報のみ, U: 自分の情報のみ, D: 不可, 管理ページログイン可 |
| 3 | Viewer | '1' | 自動生成 | 自動生成 | 本番個人サイトページ表示用にて利用, C: 不可, R: 自テナントの情報のみ, U: 不可, D: 不可, 管理ページログイン不可 |
| 4 | Sample Admin | '1' | 自動生成 | 自動生成 | 本番サンプルユーザ用にて利用, C: 不可, R: 自テナントの情報のみ, U: 不可, D: 不可, 管理ページログイン可 |

※Anonユーザはアクセス不可
