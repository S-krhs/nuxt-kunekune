# プロフィール履歴

プロフィールの履歴を管理するテーブル。

## テーブル情報

| 項目 | 値 |
|---|---|
| 論理テーブル名 | プロフィール履歴 |
| 物理テーブル名 | profile_histories |

## カラム情報

| カラム名 | データ型 | 制約 | インデックス | 外部キー | 説明 |
|------|------|------|------|------|------|
| id | INT | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY | - | - | プロフィール履歴ID |
| header_text | TEXT | NOT NULL | - | - | ヘッダ表示文言 |
| name | TEXT | NOT NULL | - | - | プロフィール表示名 |
| introduction | TEXT | NOT NULL | - | - | 自己紹介 |
| profile_image_id | UUID | NOT NULL | - | profile_images | プロフィール画像ID |
| tenant_id | TEXT | NOT NULL | - | tenants | テナントID |
| status | TEXT | NOT NULL, DEFAULT '1' | - | - | 0: 無効<br>1: 有効 |
| created_by | UUID | NOT NULL, DEFAULT auth.uid() | - | - | レコードの作成ユーザ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | - | - | レコードの作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | - | - | レコードの更新日時<br>TRIGGERによる自動更新 |
| descriptions | TEXT | - | - | - | 補足 |

## トリガー

| No. | 論理名 | 物理名 | 概要 | 補足 |
|----|---|---|---|---|
| 1 | 日時自動更新 | - | updated_atを自動で更新する | - |

## 権限設定

RLS有効

| No. | ポリシー名 | permission_name | select | insert | update | delete |
|---|---|---|---|---|---|---|
| 1 | "Privilege Users have full access." | Privilege | * | * | * | * |
| 2 | "Admin Users can select rows for the tenant they belong to." | Admin | 自テナントの情報のみ | - | - | - |
| 3 | "Admin Users can insert their own rows." | Admin | - | 自分の情報のみ | - | - |
| 4 | "Admin Users can update their own rows." | Admin | - | - | 自分の情報のみ | - |
| 5 | "Sample Users can select rows for the tenant they belong to." | Sample | 自分の情報のみ | - | - | - |


## SQL定義

```sql
-- 05.プロフィール履歴
-- -- テーブル
CREATE TABLE profile_histories (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  header_text TEXT NOT NULL,
  name TEXT NOT NULL,
  introduction TEXT NOT NULL,
  profile_image_id UUID NOT NULL REFERENCES profile_images(id),
  tenant_id INT NOT NULL REFERENCES tenants(id),
  status TEXT NOT NULL DEFAULT '1',
  created_by UUID NOT NULL DEFAULT auth.uid() REFERENCES auth.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  descriptions TEXT
);

-- -- トリガー
create trigger handle_profile_histories_updated_at before update on profile_histories
  for each row execute procedure moddatetime (updated_at);

-- -- RLS
alter table profile_histories enable row level security;
create policy "Privilege Users have full access."
  on public.profile_histories
  to authenticated
  using (
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = 1
    )
  );

create policy "Admin Users can select rows for the tenant they belong to."
  on public.profile_histories
  for select
  to authenticated
  using (
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = 2
      )
    and auth.uid() in (
      select user_id
        from user_tenants
        where user_tenants.tenant_id = profile_histories.tenant_id
      )
  );

create policy "Admin Users can insert their own rows."
  on public.profile_histories
  for insert
  to authenticated
  with check(
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = 2
      )
    and auth.uid() = profile_histories.created_by
  );

create policy "Admin Users can update their own rows."
  on public.profile_histories
  for update
  to authenticated
  using (
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = 2
      )
    and auth.uid() = profile_histories.created_by
  )
  with check(
    auth.uid() = profile_histories.created_by
  );

create policy "Sample Users can select rows for the tenant they belong to."
  on public.profile_histories
  for select
  to authenticated
  using (
    auth.uid() in (
      select user_id
        from user_permissions
        where user_permissions.permission_id = 3
    )
    and auth.uid() in (
      select user_id
        from user_tenants
        where user_tenants.tenant_id = profile_histories.tenant_id
      )
  );

```
